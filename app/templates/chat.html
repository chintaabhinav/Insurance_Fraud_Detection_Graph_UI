{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto h-[calc(100vh-140px)] flex flex-col">
    <!-- Chat Header -->
    <div class="glass-panel rounded-t-2xl p-4 border-b border-white/5 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div
                class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                <i class="fa-solid fa-robot text-white"></i>
            </div>
            <div>
                <h2 class="font-semibold text-white">Graph Assistant</h2>
                <p class="text-xs text-emerald-400 flex items-center gap-1"><span
                        class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> Online</p>
            </div>
        </div>
        <button class="text-slate-400 hover:text-white"><i class="fa-solid fa-rotate-right"></i></button>
    </div>

    <!-- Chat Messages -->
    <div class="glass-card flex-grow overflow-y-auto p-6 space-y-6 bg-slate-900/20 backdrop-blur-sm"
        id="chat-container">
        <!-- Bot Welcome -->
        <div class="flex gap-4">
            <div
                class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center flex-shrink-0 border border-purple-500/30">
                <i class="fa-solid fa-robot text-purple-400 text-xs"></i>
            </div>
            <div
                class="bg-slate-800/80 border border-white/5 rounded-2xl rounded-tl-none p-4 max-w-[80%] text-slate-200 text-sm shadow-lg">
                <p>Hello! I'm your Fraud Detection Assistant. I can query the Neo4j graph to find hidden patterns. Try
                    asking:</p>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button
                        class="suggestion-chip px-3 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs hover:bg-blue-500/20 transition-colors"
                        onclick="sendSuggestion(this)">Show me high risk claims</button>
                    <button
                        class="suggestion-chip px-3 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs hover:bg-blue-500/20 transition-colors"
                        onclick="sendSuggestion(this)">Identify fraud rings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="glass-panel rounded-b-2xl p-4 border-t border-white/5">
        <form id="chat-form" class="relative">
            <input type="text" id="chat-input" placeholder="Ask a question about the claims graph..."
                class="w-full bg-slate-900/50 border border-slate-700 rounded-xl pl-4 pr-12 py-3.5 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all">
            <button type="submit"
                class="absolute right-2 top-1/2 transform -translate-y-1/2 w-9 h-9 rounded-lg bg-blue-600 hover:bg-blue-500 flex items-center justify-center text-white transition-colors">
                <i class="fa-solid fa-paper-plane text-xs"></i>
            </button>
        </form>
    </div>
</div>

<script>
    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    function appendMessage(role, content) {
        const isUser = role === 'user';
        const html = `
            <div class="flex gap-4 ${isUser ? 'flex-row-reverse' : ''}">
                <div class="w-8 h-8 rounded-full ${isUser ? 'bg-blue-500/20 border-blue-500/30' : 'bg-purple-500/20 border-purple-500/30'} flex items-center justify-center flex-shrink-0 border">
                    <i class="fa-solid ${isUser ? 'fa-user text-blue-400' : 'fa-robot text-purple-400'} text-xs"></i>
                </div>
                <div class="${isUser ? 'bg-blue-600/20 border-blue-500/20' : 'bg-slate-800/80 border-white/5'} border rounded-2xl ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} p-4 max-w-[80%] text-slate-200 text-sm shadow-lg">
                    <p>${content}</p>
                </div>
            </div>
        `;
        chatContainer.insertAdjacentHTML('beforeend', html);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function handleSubmit(e) {
        e.preventDefault();
        const msg = chatInput.value.trim();
        if (!msg) return;

        // User Msg
        appendMessage('user', msg);
        chatInput.value = '';

        // Loading State
        const loadingId = 'loading-' + Date.now();
        const loadingHtml = `
            <div id="${loadingId}" class="flex gap-4">
                <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center flex-shrink-0 border border-purple-500/30">
                    <i class="fa-solid fa-robot text-purple-400 text-xs"></i>
                </div>
                <div class="bg-slate-800/80 border border-white/5 rounded-2xl rounded-tl-none p-4 text-slate-400 text-sm">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> Thinking...
                </div>
            </div>
        `;
        chatContainer.insertAdjacentHTML('beforeend', loadingHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // API Call
        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            });
            const data = await res.json();

            // Remove loading
            document.getElementById(loadingId).remove();
            appendMessage('bot', data.response);
        } catch (err) {
            document.getElementById(loadingId).remove();
            appendMessage('bot', "Sorry, I encountered an error connecting to the backend.");
        }
    }

    function sendSuggestion(btn) {
        chatInput.value = btn.innerText;
        chatForm.dispatchEvent(new Event('submit'));
    }

    chatForm.addEventListener('submit', handleSubmit);
</script>
{% endblock %}